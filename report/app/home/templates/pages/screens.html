{% extends "pages/main.html" %}

{% block style %}
<style>
    .videostream {
        width: 1500px !important;
        box-sizing: content-box;
    }

    .render {
        box-sizing: content-box;
        margin: 1%;
    }
</style>
{% endblock %}

{% block content %}

<!-- 21:9 aspect ratio -->
<div class="container videostream">
    <video class="responsive-item render" id="videoInput"></video>
    <canvas class="render" id="canvasOutput"></canvas>
</div>
<div id="abc">
    
</div>
{% load static %}
<script src="{% static 'js/opencv.js' %}" type="text/javascript"></script>
<script type="text/javascript">
    let video = document.getElementById("videoInput"); // video is the id of video tag
    video.width = 640;
    video.height = 480;
    navigator.mediaDevices
        .getUserMedia({
            video: true,
            audio: false
        })
        .then(function (stream) {
            video.srcObject = stream;
            video.play();

            let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let dst = new cv.Mat(video.height, video.width, cv.CV_8UC3);
            let cap = new cv.VideoCapture(video);
            var stop = 0;
            var i = 1;

            function processVideo() {
                try {
                    i++;
                    // start processing.
                    cap.read(src);
                    cv.cvtColor(src, dst, cv.COLOR_RGBA2BGR);
                    // console.log(dst.data);

                    // var encodedString = btoa(ar)

                    const Http = new XMLHttpRequest();
                    const url = '/indexfr/';
                    Http.open("POST", url, true);
                    // Http.send(encodedString);
                    Http.send(dst.data);
                    // console.log(dst.data)
                    cv.imshow("canvasOutput", src);
                    Http.onreadystatechange = function () {

                        if (this.readyState == 4 && this.status == 200) {
                            // Http.responseType = "json";
                            var serverResponse = JSON.parse(Http.responseText);
                            var i = 0;
                            for (predict of serverResponse.predicts) {
                                var td = predict.bounding_box;
                                var x = td[0];
                                var y = td[1];
                                var w = td[2] - td[0];
                                var h = td[3] - td[1];
                                var c = document.getElementById("canvasOutput");
                                var ctx = c.getContext("2d");
                                ctx.beginPath();
                                ctx.lineWidth = "3";
                                ctx.strokeStyle = "red";
                                ctx.rect(x, y, w, h);
                                ctx.stroke();

                                
                                console.log(serverResponse.data[i]);
                                var x = serverResponse.data[i];
                                console.log(x);
                                const div = document.createElement('div');
                                div.innerHTML = `
                                    <h1 id="name`+i+`">Name: </h1>
                                    <h1 id="description`+i+`">Description: </h1>
                                    <br>
                                `;
                                document.getElementById('abc').appendChild(div);

                                document.getElementById('name'+i.toString()).append(x['name']);
                                document.getElementById('description'+i.toString()).append(x['description']);
                                i++;
                            }
                        }
                    }
                } catch (err) {
                    console.error(err);
                }
                // document.getElementById("videoInput").setAttribute("hidden", "");
                // document.getElementById("canvasOutput").removeAttribute("hidden");
            }
            // schedule the first one.
            setTimeout(processVideo, 2000);


        })
</script>

{% endblock %}
