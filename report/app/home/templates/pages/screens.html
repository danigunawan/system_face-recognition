<!DOCTYPE html>
<html>
<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<p id="status">OpenCV.js is loading...</p>
{{check}}
<div>
  <!-- <div class="inputoutput">
    <img id="imageSrc" alt="No Image" />
    <div class="caption">imageSrc <input type="file" id="fileInput" name="file" /></div>
  </div> -->
  <div class="inputoutput">
    <video id="videoInput"></video> 
    <canvas id="canvasOutput">

    </canvas>
</div>

<script type="text/javascript">

let video = document.getElementById("videoInput"); // video is the id of video tag
video.width = 640;
video.height = 480;
navigator.mediaDevices
  .getUserMedia({ video: true, audio: false })
  .then(function(stream) {
    video.srcObject = stream;
    video.play();
  
    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let dst = new cv.Mat(video.height, video.width, cv.CV_8UC3);
    let cap = new cv.VideoCapture(video);

    var i = 1;
    function processVideo() {
      try {
        i++;
        // start processing.
        cap.read(src);
        
        cv.cvtColor(src, dst, cv.COLOR_RGBA2BGR);
        console.log(i, dst);
        cv.imshow("canvasOutput", dst);
        if(i<5)
        {
          setTimeout(processVideo, 1);
        }
        else
        {
          var ar = "";
          for(const i of dst.data)
            ar+=i.toString()+',';
          ar = ar.substring(0, ar.length - 1);
          console.log(ar);
          $.ajax({
            "type": "POST",
            // "dataType": "json",
            "url": "/indexfr/",
            "data": ar,
            "success": function(result) {
                console.log(result);
            },
          });
        }
          
      } catch (err) {
        console.error(err);
      }
    }
    // schedule the first one.
    setTimeout(processVideo, 0);
  })

</script>
{% load static %}
<script src="{% static 'js/opencv.js' %}"  type="text/javascript"></script>
</body>